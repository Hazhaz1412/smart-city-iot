# Smart City Backend - N·ªÅn t·∫£ng D·ªØ li·ªáu ƒê√¥ th·ªã M·ªü

H·ªá th·ªëng backend cho ·ª©ng d·ª•ng th√†nh ph·ªë th√¥ng minh d·ª±a tr√™n n·ªÅn t·∫£ng d·ªØ li·ªáu m·ªü, tu√¢n th·ªß c√°c ti√™u chu·∫©n NGSI-LD, SOSA/SSN v√† t√≠ch h·ª£p v·ªõi Orion-LD Context Broker.

## üèóÔ∏è Ki·∫øn tr√∫c H·ªá th·ªëng

### C√¥ng ngh·ªá s·ª≠ d·ª•ng
- **Backend Framework**: Django 4.2 + Django REST Framework
- **Database**: PostgreSQL 15
- **Context Broker**: Orion-LD (FIWARE)
- **Message Queue**: Redis + Celery
- **Containerization**: Docker + Docker Compose
- **Standards**: NGSI-LD, SOSA/SSN, JSON-LD

### C√°c th√†nh ph·∫ßn ch√≠nh

1. **Core Module**: X·ª≠ l√Ω NGSI-LD v√† JSON-LD
2. **Entities Module**: Qu·∫£n l√Ω c√°c entities (Weather Stations, Sensors, Public Services)
3. **Sensors Module**: Qu·∫£n l√Ω sensors d·ª±a tr√™n SOSA/SSN ontology
4. **Observations Module**: L∆∞u tr·ªØ v√† truy v·∫•n observations
5. **Integrations Module**: T√≠ch h·ª£p v·ªõi ngu·ªìn d·ªØ li·ªáu m·ªü (OpenWeatherMap, OpenAQ)

## üöÄ C√†i ƒë·∫∑t v√† Ch·∫°y

### Y√™u c·∫ßu h·ªá th·ªëng
- Docker & Docker Compose
- Python 3.11+
- Git

### B∆∞·ªõc 1: Clone repository

```bash
git clone <repository-url>
cd OPS-2
```

### B∆∞·ªõc 2: C·∫•u h√¨nh m√¥i tr∆∞·ªùng

```bash
cp .env.example .env
```

Ch·ªânh s·ª≠a file `.env` v√† th√™m API keys c·ªßa b·∫°n:

```env
DEBUG=True
SECRET_KEY=your-secret-key-here
DATABASE_NAME=smartcity_db
DATABASE_USER=postgres
DATABASE_PASSWORD=postgres
DATABASE_HOST=postgres
DATABASE_PORT=5432

# Orion-LD Context Broker
ORION_LD_URL=http://orion-ld:1026

# External APIs
OPENWEATHER_API_KEY=your_api_key_here
OPENAQ_API_KEY=your_api_key_here

# Redis
REDIS_URL=redis://redis:6379/0
```

### B∆∞·ªõc 3: Kh·ªüi ƒë·ªông h·ªá th·ªëng b·∫±ng Docker

```bash
# Build v√† kh·ªüi ƒë·ªông t·∫•t c·∫£ services
docker-compose up -d

# Xem logs
docker-compose logs -f
```

### B∆∞·ªõc 4: Ch·∫°y migrations

```bash
# Ch·∫°y migrations
docker-compose exec django python manage.py makemigrations
docker-compose exec django python manage.py migrate

# T·∫°o superuser
docker-compose exec django python manage.py createsuperuser
```

### B∆∞·ªõc 5: Load d·ªØ li·ªáu m·∫´u (optional)

```bash
# T·∫°o d·ªØ li·ªáu m·∫´u
docker-compose exec django python manage.py shell < scripts/load_sample_data.py
```

## üì° API Endpoints

### Core APIs

#### Health Check
```
GET /api/v1/health
```

#### JSON-LD Context
```
GET /api/v1/context
```

### Entity Management

#### Entities
```
GET    /api/v1/entities/              # List all entities
POST   /api/v1/entities/              # Create entity
GET    /api/v1/entities/{id}/         # Get entity
PUT    /api/v1/entities/{id}/         # Update entity
DELETE /api/v1/entities/{id}/         # Delete entity
POST   /api/v1/entities/{id}/sync_to_orion/  # Sync to Orion-LD
GET    /api/v1/entities/query_orion/  # Query from Orion-LD
```

#### Weather Stations
```
GET    /api/v1/weather-stations/      # List weather stations
POST   /api/v1/weather-stations/      # Create station
GET    /api/v1/weather-stations/nearby/?lat={lat}&lon={lon}&radius={km}
```

#### Air Quality Sensors
```
GET    /api/v1/air-quality-sensors/   # List sensors
POST   /api/v1/air-quality-sensors/   # Create sensor
```

#### Public Services
```
GET    /api/v1/public-services/       # List services
POST   /api/v1/public-services/       # Create service
GET    /api/v1/public-services/nearby/?lat={lat}&lon={lon}&type={type}
```

### Observations

#### Weather Observations
```
GET    /api/v1/weather/               # List observations
POST   /api/v1/weather/               # Create observation
GET    /api/v1/weather/latest/?lat={lat}&lon={lon}
GET    /api/v1/weather/?hours=24     # Last 24 hours
```

#### Air Quality Observations
```
GET    /api/v1/air-quality/           # List observations
POST   /api/v1/air-quality/           # Create observation
GET    /api/v1/air-quality/latest/?lat={lat}&lon={lon}
```

#### Traffic Observations
```
GET    /api/v1/traffic/               # List observations
POST   /api/v1/traffic/               # Create observation
```

### Data Integration

#### Sync Data
```
POST   /api/v1/sync/weather           # Sync all weather stations
POST   /api/v1/sync/air-quality       # Sync all air quality sensors
```

#### Fetch Single Location
```
GET    /api/v1/fetch/weather?lat={lat}&lon={lon}
POST   /api/v1/fetch/weather          # Save to database
GET    /api/v1/fetch/air-quality?lat={lat}&lon={lon}
POST   /api/v1/fetch/air-quality      # Save to database
```

## üîß V√≠ d·ª• S·ª≠ d·ª•ng

### 1. T·∫°o Weather Station

```bash
curl -X POST http://localhost:8000/api/v1/weather-stations/ \
  -H "Content-Type: application/json" \
  -d '{
    "station_id": "hanoi-station-1",
    "name": "Tr·∫°m Th·ªùi ti·∫øt H√† N·ªôi",
    "latitude": 21.0285,
    "longitude": 105.8542,
    "address": "H√† N·ªôi, Vi·ªát Nam"
  }'
```

### 2. L·∫•y d·ªØ li·ªáu th·ªùi ti·∫øt t·ª´ OpenWeatherMap

```bash
curl -X GET "http://localhost:8000/api/v1/fetch/weather?lat=21.0285&lon=105.8542"
```

### 3. Query NGSI-LD entities t·ª´ Orion-LD

```bash
curl -X GET "http://localhost:8000/api/v1/entities/query_orion/?type=WeatherStation"
```

### 4. L·∫•y d·ªØ li·ªáu ch·∫•t l∆∞·ª£ng kh√¥ng kh√≠ g·∫ßn nh·∫•t

```bash
curl -X GET "http://localhost:8000/api/v1/air-quality/latest/?lat=21.0285&lon=105.8542"
```

## üìä M√¥ h√¨nh D·ªØ li·ªáu NGSI-LD

### Weather Station Entity

```json
{
  "id": "urn:ngsi-ld:WeatherStation:hanoi-station-1",
  "type": "WeatherStation",
  "@context": [
    "https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld",
    {
      "smartcity": "https://smartcity.example.com/ontology#"
    }
  ],
  "name": {
    "type": "Property",
    "value": "Tr·∫°m Th·ªùi ti·∫øt H√† N·ªôi"
  },
  "location": {
    "type": "GeoProperty",
    "value": {
      "type": "Point",
      "coordinates": [105.8542, 21.0285]
    }
  }
}
```

### Air Quality Observed Entity

```json
{
  "id": "urn:ngsi-ld:AirQualityObserved:hanoi-20241124",
  "type": "AirQualityObserved",
  "@context": [
    "https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld",
    {
      "smartcity": "https://smartcity.example.com/ontology#"
    }
  ],
  "location": {
    "type": "GeoProperty",
    "value": {
      "type": "Point",
      "coordinates": [105.8542, 21.0285]
    }
  },
  "airQualityIndex": {
    "type": "Property",
    "value": 85,
    "observedAt": "2024-11-24T10:00:00Z"
  },
  "pm25": {
    "type": "Property",
    "value": 28.5,
    "unitCode": "GQ",
    "observedAt": "2024-11-24T10:00:00Z"
  }
}
```

## üîÑ Celery Tasks

H·ªá th·ªëng s·ª≠ d·ª•ng Celery ƒë·ªÉ ƒë·ªìng b·ªô d·ªØ li·ªáu ƒë·ªãnh k·ª≥:

- **sync_weather_data**: Ch·∫°y m·ªói 15 ph√∫t
- **sync_air_quality_data**: Ch·∫°y m·ªói 30 ph√∫t

Xem tr·∫°ng th√°i tasks:

```bash
docker-compose logs celery_worker
docker-compose logs celery_beat
```

## üóÑÔ∏è Database Schema

### Entity Model
- L∆∞u tr·ªØ t·∫•t c·∫£ NGSI-LD entities
- H·ªó tr·ª£ spatial queries
- Tracking sync status v·ªõi Orion-LD

### Observations Models
- WeatherObservation
- AirQualityObservation
- TrafficObservation

### Sensors Models (SOSA/SSN)
- Sensor
- Platform
- SensorDeployment

## üß™ Testing

```bash
# Run tests
docker-compose exec django python manage.py test

# Run specific app tests
docker-compose exec django python manage.py test entities
docker-compose exec django python manage.py test observations
```

## üìù Development

### Th√™m Migration

```bash
docker-compose exec django python manage.py makemigrations
docker-compose exec django python manage.py migrate
```

### Django Shell

```bash
docker-compose exec django python manage.py shell
```

### Truy c·∫≠p Django Admin

Truy c·∫≠p: http://localhost:8000/admin

## üõ†Ô∏è Troubleshooting

### Orion-LD kh√¥ng kh·ªüi ƒë·ªông

```bash
# Restart Orion-LD v√† MongoDB
docker-compose restart mongo orion-ld

# Check logs
docker-compose logs orion-ld
```

### Database connection issues

```bash
# Restart PostgreSQL
docker-compose restart postgres

# Check connection
docker-compose exec django python manage.py dbshell
```

## üìö T√†i li·ªáu Tham kh·∫£o

- [NGSI-LD Specification](https://www.etsi.org/deliver/etsi_gs/CIM/001_099/009/01.04.01_60/gs_cim009v010401p.pdf)
- [SOSA/SSN Ontology](https://www.w3.org/TR/vocab-ssn/)
- [FIWARE Smart Data Models](https://smartdatamodels.org/)
- [Orion-LD Documentation](https://fiware-orion.readthedocs.io/)
- [Django REST Framework](https://www.django-rest-framework.org/)

## ü§ù Contributing

1. Fork the project
2. Create your feature branch (`git checkout -b feature/AmazingFeature`)
3. Commit your changes (`git commit -m 'Add some AmazingFeature'`)
4. Push to the branch (`git push origin feature/AmazingFeature`)
5. Open a Pull Request

## üìÑ License

This project is licensed under the MIT License.

## üë• Team

D·ª± √°n ƒë∆∞·ª£c ph√°t tri·ªÉn cho cu·ªôc thi OLP 2025 - Ph·∫ßn m·ªÅm ngu·ªìn m·ªü.

## üìû Contact

Email: your-email@example.com
